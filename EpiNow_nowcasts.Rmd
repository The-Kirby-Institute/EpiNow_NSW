# Now casting script for running EpiNow2 on NSW COVID case data
# =============================================================

```{r Set-up}
# Open as a project (setting working directory to source and restarting R)

# Packages
require(EpiNow2, quietly = TRUE)
require(tidyverse, quietly = TRUE)
require(lubridate, quietly = TRUE)
require(future, quietly = TRUE)

# Functions 
source("code/GetCases.R")
source("code/LoadData.R")
source("code/SpecifyRegions.R")
source("code/RegionalSummary.R")
```

```{r User inputs}
# Chunk where user enters all teh input options for running EpiNow
regionLevel <- "LGA" # "NSW", "Sydney",  or "LGA"
startDate <- "2021-06-01" # Filter to after this date (to speed up 
                          # computation)
dateRun <- NULL # Run to this date: NULL = last date in data file
regionOptions <- SpecifyRegions(regionLevel, "TestLGAs") 
specificRegions <- regionOptions[[1]]
resultsFolder <- regionOptions[[2]] # or manually add
dataOption <- "nsw_website" # "nsw_website" or "file"
delayOption <- "nsw_data" # nsw_data (dafault), "testing", "international"
```

```{r Set-up outputs}
if ((regionLevel == "LGA" & length(specificRegions) > 1) |
    (regionLevel == "LGA" & specificRegions[1] == "all")) {
  regionalRun <- TRUE
  epiFunction <- EpiNow2::regional_epinow
} else {
  regionalRun <- FALSE
  epiFunction <- EpiNow2::epinow
}

dir.create(file.path("results", resultsFolder), showWarnings = FALSE)
```

```{r Sort out case data}
# Load raw case data 
print("Retrieving raw cases data...")
nsw_raw_cases <- LoadData(dataOption)

# Save website data
if (dataOption == "nsw_website") {
  write_csv(nsw_raw_cases, file = file.path("data", 
    paste0("NSW_Health_Website_Data-", Sys.Date())))
}
# Get cases we want 
print("Getting cases...")

cases <- GetCases(nsw_raw_cases, dataOption, regionLevel, startDate, 
  regions = specificRegions) %>%
  arrange(region)

if(!is.null(dateRun)) {
  cases <- reported_cases %>% 
    filter(date <= dateRun)
}

if (!regionalRun) {
  cases <- reported_cases %>%
    select(-region)
}
```

```{r Load EpiNow delay parameters}
print("Loading delay definitions...")

if (delayOption == "nsw_data") {
  # Load delay_defs fitted from local nsw data
  reporting_delay <- readRDS("data/local_delays.rds")
} else if (delayOption == "testing") {
  reporting_delay <- list(mean = convert_to_logmean(4, 1),
    mean_sd = 0.1,
    sd = convert_to_logsd(4, 1),
    sd_sd = 0.1,
    max = 15)
} else if (delayOption == "international") {
  v <- readRDS("data/international_delays.rds")
} else {
  stop("Unknown lineData option")
}

generation_time <- EpiNow2::get_generation_time(disease = "SARS-CoV-2", 
  source = "ganyani")
incubation_period <- EpiNow2::get_incubation_period(disease = "SARS-CoV-2", 
  source = "lauer")
```

```{r Set-up simulations}
print("Setting up EpiNow...")
if (!interactive()){
  options(future.fork.enable = TRUE)
}

future::plan("multiprocess", workers = round(future::availableCores() / 2))
```

```{r Run EpiNow}
estimates <- epiFunction(reported_cases = cases, 
  generation_time = generation_time,
  delays = delay_opts(incubation_period, reporting_delay),
  # Need to tweak prior for Rt I would think
  rt = rt_opts(prior = list(mean = 1.5, sd = 0.5)),
  stan = stan_opts(),
  target_folder = file.path("results", resultsFolder),
  logs = file.path("logs", Sys.Date()),
  return_output = TRUE, 
  verbose = TRUE)

# Save everything in the results folder
save(regionLevel, startDate, dateRun, specificRegions, dataOption, 
  delayOption, cases, estimates,
  resultsFolder, generation_time, incubation_period, reporting_delay,
  file = file.path("results", resultsFolder, paste0("Epinow_results-", 
    format(Sys.time(), "%Y-%m-%d_%H-%M-%S"))))
```

```{r Summarise results}
# Commands for looking at individual region results
# > summary(estimates)
# > plot(estimates)
# > summary(estimates, type = "parameters", params = "R")

# For regional results we can generate a regional summary
if (regionalRun) {
  # The following command won't run if some regions do not have all the 
  # results files. If you strike an error check that all the result folders 
  # and files have been generated by EpiNow. 
  print("Producing regional summary ...")
  
  RegionalSummary(estimates, resultsFolder)
  
}

```
