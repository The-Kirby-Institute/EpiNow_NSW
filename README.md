# EpiNow Wrapper for NSW 

Wrapper of the London School of Hygiene and Tropical Medicine `{EpiNow2}` R package for application to NSW COVID-19 case data. 

**NOTE:** Documentation not complete within all the scripts and functions but hopefully clear enough to work out.

Details of the `{EpiNow2}` package are available from ["EpiNow2: Estimate real-time case counts and time-varying epidemiological parameters"](https://epiforecasts.io/EpiNow2/) with the underlying methods described in ["Estimating the time-varying reproduction number of SARS-CoV-2 using national and subnational case counts"](https://wellcomeopenresearch.org/articles/5-112/v1). 
<br><br>
The scripts and functions are written as R or Rmarkdown scripts and were developed using R version 4.1.1 (2021-08-10) with [Rstudio](https://www.rstudio.com/) version 1.4.1717 with the associated packages (EpiNow2 1.3.2; future 1.21.0; lubridate 1.7.10; forcats 0.5.1; stringr 1.4.0; dplyr 1.0.7; purrr 0.3.4; readr 2.0.1; tidyr 1.1.3; tibble 3.1.3; ggplot2 3.3.5; tidyverse 1.3.1; segmented 1.3.4). 

**Developer:** Richard T. Gray <br>
**Affiliation:** [_The Kirby Institute_](https://kirby.unsw.edu.au/), UNSW Sydney, Sydney NSW 2052, Australia. 

## Organization

All the project files are stored in the main directory and three main sub-directories. All inputs and outputs stored as `.csv` or `.rds` files. 

_Main directory scripts_

The following R markdown scripts are used to run the `{EpiNow2}` functions and generate results. The files are numbered from 0 to specify the order they need to be run to produce all the results. 

- **0-EpiNow_Install.R**: This script installs `{EpiNow2}`, associated packages, and other R packages required. Only needs to be run once.
 
- **1-EpiNow_update_delays.R**": This script is used to generate the statistical properties of the distribution for the reporting delay (time between onset to case confirmation). It uses individual data from the whole of the specified data set to produce an output file  `data/local_delays.rds` that is read by the main script. The user has to enter the input data location. It can take some time to run, so should only been run every week or so. Pre-generated files are available in the `data` directory. 

- **2-EpiNow_nowcasts.Rmd**: This Rmarkdown script is the main script for the project and is the primary script used by the user to generate the results. The User has to enter inputs within the `{r User inputs}` Rmarkdown chunk (see User Specification Options below). EpiNow will take a significant amount of time to run even with a multi-core parallel set-up. On a standard desktop computer with 4 cores it takes about 5-6 hours to run for 50 regions. 

#### code ####

Contains all the specific R functions used by the main directory scripts.

#### data ####

Contains all the input data files used by the the main directory scripts. It also contains outputs from data processing scripts such as the `local_delays.rds` generated by `1-EpiNow_update_delays.R`. 

#### results ####

Contains all the results generated by EpiNow2. The results from each run of the `2-EpiNow_nowcasts.Rmd` script are placed within a separate user specified folder with separate folders for each region by date. Summarized results for LGAs are provided in a separate folder `LGA-summary`. For each region results are saved within `.rds` and `.csv` files and as PNG formatted plots.    

## How to run the code

To set-up and run the code:
* Source `0-EpiNow_Install.R` to install the `{EpiNow2}` packaged and other required packages.
* (Optional) Source `1-EpiNow_update_delays.R` to generate the reporting delay distribution data if required. Alternatively the pre-generated files can be used. 
* Enter required inputs into the `2-EpiNow_nowcasts.Rmd` and source to generate the results. 

## User specification options

To run the main `2-EpiNow_nowcasts.Rmd` script the user needs to enter values for the following input variables:

* dateRun: Date that the `EpiNow2::epinow()` runs to. Set to NULL to run to the latest date in the input data.
* startDate: Date that `EpiNow2::epinow()` runs from. Data is filtered out before this date. Used to focus on a particular period or to improve processing time.  
* dataOption: Specify where the data comes from either the NSW Health website (`dataOption <- nsw_website`) or a user specified file see `./code/LoadData.R`. 
* delayOption: Specify where the reporting delay distribution specifications come from. Default is `nsw_data` which loads `./data/local_delays.rds`. 
* specificRegions: Specify specific regions for producing results. Can manually enter these or use the function `SpecfiyRegions()`. Set `specificRegions <- all` for results for NSW overall and each LGA to be generated.
* resultsFolder: Specify where results will be saved. 

## Changes to EpiNow2 functions

To produce a NSW specific LGA summary plot the `{EpiNow2}` functions `plot_summary()` and `regional_summary()` were copied and tweaked. These functions are in the `code/` folder and named `plot_summary_NSW()` and `regional_summary()`, respectively.  






